#!/usr/bin/env php
<?php

/**
 * MAAF App Installer - Jav√≠tott verzi√≥
 * 
 * Ez egy p√©lda, hogyan lehetne kieg√©sz√≠teni az installer-t
 */

// ... megl√©v≈ë k√≥d ...

// √öJ FUNKCI√ìK:

// 1. Git inicializ√°l√°s
function initializeGit(): void
{
    if (is_dir('.git')) {
        echo "  ‚ÑπÔ∏è  Git m√°r inicializ√°lva\n";
        return;
    }
    
    exec('git init', $output, $returnCode);
    if ($returnCode === 0) {
        echo "  ‚úì Git inicializ√°lva\n";
        
        // Kezdeti commit
        exec('git add .', $output, $returnCode);
        exec('git commit -m "Initial commit"', $output, $returnCode);
        if ($returnCode === 0) {
            echo "  ‚úì Kezdeti commit l√©trehozva\n";
        }
    } else {
        echo "  ‚ö†Ô∏è  Git inicializ√°l√°s sikertelen (git nincs telep√≠tve?)\n";
    }
}

// 2. Database connection test
function testDatabaseConnection(array $dbConfig, string $driver): bool
{
    try {
        if ($driver === 'sqlite') {
            $path = $dbConfig['database'] ?? 'database/database.sqlite';
            $fullPath = __DIR__ . '/' . $path;
            
            // K√∂nyvt√°r l√©trehoz√°sa, ha nem l√©tezik
            $dir = dirname($fullPath);
            if (!is_dir($dir)) {
                mkdir($dir, 0755, true);
            }
            
            // F√°jl l√©trehoz√°sa, ha nem l√©tezik
            if (!file_exists($fullPath)) {
                touch($fullPath);
            }
            
            $pdo = new PDO('sqlite:' . $fullPath);
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $pdo->query('SELECT 1');
            
            return true;
        } else {
            $host = $dbConfig['host'] ?? 'localhost';
            $port = $dbConfig['port'] ?? ($driver === 'mysql' ? '3306' : '5432');
            $database = $dbConfig['database'] ?? '';
            $username = $dbConfig['username'] ?? 'root';
            $password = $dbConfig['password'] ?? '';
            
            $dsn = "{$driver}:host={$host};port={$port};dbname={$database};charset=utf8mb4";
            $pdo = new PDO($dsn, $username, $password);
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $pdo->query('SELECT 1');
            
            return true;
        }
    } catch (PDOException $e) {
        echo "  ‚ùå Adatb√°zis kapcsolat hiba: " . $e->getMessage() . "\n";
        return false;
    }
}

// 3. Environment validation
function validateEnvironment(array $config): array
{
    $errors = [];
    
    // JWT Secret ellen≈ërz√©s
    if (empty($config['jwtSecret']) || strlen($config['jwtSecret']) < 32) {
        $errors[] = "JWT Secret minimum 32 karakter hossz√∫s√°g√∫ kell legyen";
    }
    
    // Database ellen≈ërz√©s
    if ($config['dbDriver'] !== 'sqlite' && empty($config['dbDatabase'])) {
        $errors[] = "Adatb√°zis n√©v k√∂telez≈ë MySQL/PostgreSQL eset√©n";
    }
    
    return $errors;
}

// 4. Frontend inicializ√°l√°s - teljes implement√°ci√≥
function initializeFrontend(string $type): void
{
    if ($type === 'none') {
        return;
    }
    
    $frontendDir = __DIR__ . '/frontend';
    
    if (is_dir($frontendDir)) {
        echo "  ‚ö†Ô∏è  Frontend k√∂nyvt√°r m√°r l√©tezik\n";
        return;
    }
    
    echo "  üì¶ Frontend inicializ√°l√°sa ({$type})...\n";
    
    // Vite template nevek
    $templates = [
        'react' => 'react',
        'vue' => 'vue',
        'vanilla' => 'vanilla',
    ];
    
    $template = $templates[$type] ?? 'vanilla';
    
    // npm create vite parancs futtat√°sa
    $command = "npm create vite@latest frontend -- --template {$template} --yes";
    exec($command, $output, $returnCode);
    
    if ($returnCode === 0) {
        echo "  ‚úì Frontend inicializ√°lva\n";
        
        // Vite config friss√≠t√©se proxy-val
        updateViteConfig($frontendDir);
        
        // Frontend .env f√°jl l√©trehoz√°sa
        createFrontendEnv($frontendDir);
    } else {
        echo "  ‚ö†Ô∏è  Frontend inicializ√°l√°s sikertelen (npm nincs telep√≠tve?)\n";
        echo "     K√©zzel inicializ√°ld: npm create vite@latest frontend -- --template {$template}\n";
    }
}

function updateViteConfig(string $frontendDir): void
{
    $viteConfigPath = $frontendDir . '/vite.config.js';
    
    if (!file_exists($viteConfigPath)) {
        return;
    }
    
    $config = file_get_contents($viteConfigPath);
    
    // Proxy konfigur√°ci√≥ hozz√°ad√°sa, ha m√©g nincs
    if (strpos($config, 'proxy') === false) {
        $proxyConfig = <<<'JS'
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        secure: false,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  },
JS;
        
        // Besz√∫r√°s a defineConfig ut√°n
        $config = str_replace(
            'export default defineConfig({',
            'export default defineConfig({' . "\n" . $proxyConfig,
            $config
        );
        
        file_put_contents($viteConfigPath, $config);
        echo "  ‚úì Vite proxy konfigur√°lva\n";
    }
}

function createFrontendEnv(string $frontendDir): void
{
    $envContent = <<<ENV
VITE_API_URL=http://localhost:8000
ENV;
    
    file_put_contents($frontendDir . '/.env', $envContent);
    echo "  ‚úì Frontend .env f√°jl l√©trehozva\n";
}

// 5. Database migrations scaffold
function createMigrationsDirectory(): void
{
    $migrationsDir = __DIR__ . '/database/migrations';
    
    if (!is_dir($migrationsDir)) {
        mkdir($migrationsDir, 0755, true);
        echo "  ‚úì Migr√°ci√≥k k√∂nyvt√°r l√©trehozva\n";
    }
    
    // P√©lda migr√°ci√≥ f√°jl
    $exampleMigration = <<<'SQL'
-- Example migration
-- This file demonstrates how to create a migration

CREATE TABLE IF NOT EXISTS example_table (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
SQL;
    
    $exampleFile = $migrationsDir . '/0001_create_example_table.sql';
    if (!file_exists($exampleFile)) {
        file_put_contents($exampleFile, $exampleMigration);
        echo "  ‚úì P√©lda migr√°ci√≥ l√©trehozva\n";
    }
}

// 6. Health check endpoint l√©trehoz√°sa
function createHealthCheckEndpoint(): void
{
    $healthController = <<<'PHP'
<?php

declare(strict_types=1);

namespace App\Modules\Health\Controllers;

use MAAF\Core\Http\Request;
use MAAF\Core\Http\Response;

final class HealthController
{
    public function check(Request $request): Response
    {
        return Response::json([
            'status' => 'ok',
            'timestamp' => date('c'),
            'version' => '1.0.0',
        ]);
    }
}
PHP;
    
    $healthDir = __DIR__ . '/src/Modules/Health/Controllers';
    if (!is_dir($healthDir)) {
        mkdir($healthDir, 0755, true);
    }
    
    file_put_contents($healthDir . '/HealthController.php', $healthController);
    echo "  ‚úì Health check endpoint l√©trehozva\n";
}

// HASZN√ÅLAT az installer-ben:

// Az installer v√©g√©n, a konfigur√°ci√≥ gener√°l√°sa ut√°n:

// 1. Environment validation
$validationErrors = validateEnvironment([
    'jwtSecret' => $jwtSecret,
    'dbDriver' => $selectedDb['driver'],
    'dbDatabase' => $dbConfig['database'] ?? '',
]);

if (!empty($validationErrors)) {
    echo "\n‚ö†Ô∏è  Figyelmeztet√©sek:\n";
    foreach ($validationErrors as $error) {
        echo "  - {$error}\n";
    }
}

// 2. Database connection test
echo "\nüîç Adatb√°zis kapcsolat tesztel√©se...\n";
if (testDatabaseConnection($dbConfig, $selectedDb['driver'])) {
    echo "  ‚úì Adatb√°zis kapcsolat sikeres\n";
} else {
    echo "  ‚ö†Ô∏è  Adatb√°zis kapcsolat sikertelen - ellen≈ërizd a be√°ll√≠t√°sokat\n";
}

// 3. Git inicializ√°l√°s
if ($installGitHooks) {
    echo "\nüì¶ Git inicializ√°l√°sa...\n";
    initializeGit();
}

// 4. Migr√°ci√≥k k√∂nyvt√°r
echo "\nüìÅ Migr√°ci√≥k k√∂nyvt√°r l√©trehoz√°sa...\n";
createMigrationsDirectory();

// 5. Health check endpoint
echo "\nüè• Health check endpoint l√©trehoz√°sa...\n";
createHealthCheckEndpoint();

